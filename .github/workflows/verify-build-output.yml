name: Verify Build Output

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  verify-client-bundles:
    name: Verify Client JavaScript Bundles
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for production
        run: npm run build
        env:
          NITRO_PRESET: vercel

      - name: Verify client JavaScript bundles exist
        run: |
          echo "üîç Checking for client JavaScript bundles..."

          # Count JavaScript files in Vercel output
          JS_COUNT=$(find .vercel/output/static/_nuxt -name "*.js" -type f 2>/dev/null | wc -l)

          echo "üìä Found $JS_COUNT JavaScript files"

          # Verify we have at least 100 JS files (should be 130+)
          if [ "$JS_COUNT" -lt 100 ]; then
            echo "‚ùå ERROR: Only $JS_COUNT JavaScript files found!"
            echo "Expected at least 100 files. Client bundles may not be deploying."
            echo ""
            echo "This usually indicates a build configuration issue."
            echo "Check nuxt.config.ts for custom Vite rollupOptions that conflict with Nitro."
            exit 1
          fi

          echo "‚úÖ Client bundles verified: $JS_COUNT files"

      - name: Verify cart bundles are present
        run: |
          echo "üîç Checking for cart-related bundles..."

          # Search for cart code in JavaScript bundles
          CART_BUNDLES=$(grep -l "useCart\|cartStore" .vercel/output/static/_nuxt/*.js 2>/dev/null || echo "")

          if [ -z "$CART_BUNDLES" ]; then
            echo "‚ùå ERROR: No cart code found in client bundles!"
            echo "Cart functionality will not work on deployment."
            exit 1
          fi

          echo "‚úÖ Cart code found in bundles:"
          echo "$CART_BUNDLES" | head -5

      - name: Verify Pinia bundles are present
        run: |
          echo "üîç Checking for Pinia state management..."

          # Search for Pinia code in JavaScript bundles
          PINIA_BUNDLES=$(grep -l "pinia\|createPinia" .vercel/output/static/_nuxt/*.js 2>/dev/null || echo "")

          if [ -z "$PINIA_BUNDLES" ]; then
            echo "‚ùå ERROR: No Pinia code found in client bundles!"
            echo "State management will not work on deployment."
            exit 1
          fi

          echo "‚úÖ Pinia code found in bundles"

      - name: Check for MIME type issues
        run: |
          echo "üîç Verifying output structure..."

          # Ensure all .js files are actual JavaScript, not HTML
          for file in .vercel/output/static/_nuxt/*.js; do
            if [ -f "$file" ]; then
              # Check if file starts with HTML tags (would indicate MIME type issue)
              if head -1 "$file" | grep -q "<!DOCTYPE\|<html"; then
                echo "‚ùå ERROR: $file contains HTML instead of JavaScript!"
                echo "This indicates a serious build configuration problem."
                exit 1
              fi
            fi
          done

          echo "‚úÖ All JavaScript files are valid"

      - name: Generate build report
        if: always()
        run: |
          echo "## Build Verification Report" > build-report.md
          echo "" >> build-report.md
          echo "### JavaScript Bundles" >> build-report.md
          echo "- Total JS files: $(find .vercel/output/static/_nuxt -name "*.js" -type f 2>/dev/null | wc -l)" >> build-report.md
          echo "- Total CSS files: $(find .vercel/output/static/_nuxt -name "*.css" -type f 2>/dev/null | wc -l)" >> build-report.md
          echo "" >> build-report.md
          echo "### Bundle Size" >> build-report.md
          echo '```' >> build-report.md
          du -sh .vercel/output/static/_nuxt 2>/dev/null || echo "N/A" >> build-report.md
          echo '```' >> build-report.md
          echo "" >> build-report.md
          echo "### Critical Bundles" >> build-report.md
          echo "- Cart bundles: $(grep -l "useCart\|cartStore" .vercel/output/static/_nuxt/*.js 2>/dev/null | wc -l)" >> build-report.md
          echo "- Pinia bundles: $(grep -l "pinia" .vercel/output/static/_nuxt/*.js 2>/dev/null | wc -l)" >> build-report.md

      - name: Upload build report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-verification-report
          path: build-report.md

      - name: Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Build Verification Failed**\n\nClient JavaScript bundles are not being generated correctly. This will break all client-side functionality on Vercel.\n\nPlease check the build verification workflow for details.'
            })
