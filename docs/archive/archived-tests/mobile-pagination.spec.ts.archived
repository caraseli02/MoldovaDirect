/**
 * E2E Tests for Mobile Pagination Fix
 *
 * Tests the fix for pagination issue where swipe gestures only worked on page 1.
 * Root cause: Swipe handlers were capturing stale pagination values in closures.
 *
 * Fix: Changed PaginationHandler interface to use MaybeRef<number> and use unref()
 * to unwrap computed refs in swipe handlers.
 *
 * This test validates:
 * 1. Pagination works on page 1 (baseline)
 * 2. Pagination works on page 2 (where bug occurred)
 * 3. Pagination works on page 3+ (comprehensive validation)
 * 4. URL updates correctly
 * 5. Products change when paginating
 */

import { test, expect } from '@playwright/test'

// Use mobile viewport
test.use({
  viewport: { width: 375, height: 667 }, // iPhone SE size
  isMobile: true,
  hasTouch: true
})

test.describe('Mobile Pagination - Multi-page Swipe Gestures', () => {
  test.beforeEach(async ({ page }) => {
    // Navigate to products page
    await page.goto('http://localhost:3002/products')

    // Wait for products to load
    await page.waitForSelector('[data-testid="product-card"]', {
      state: 'visible',
      timeout: 10000
    })
  })

  test('should navigate from page 1 to page 2 using swipe left gesture', async ({ page }) => {
    // Verify we're on page 1
    await expect(page).toHaveURL(/page=1|^http:\/\/localhost:3002\/products$/)

    // Get first product title on page 1
    const firstProductPage1 = await page.locator('[data-testid="product-card"]').first().textContent()

    // Simulate swipe left gesture (next page)
    const container = await page.locator('main').first()
    const box = await container.boundingBox()

    if (box) {
      // Swipe from right to left (80% to 20% of width)
      await page.mouse.move(box.x + box.width * 0.8, box.y + box.height * 0.5)
      await page.mouse.down()
      await page.mouse.move(box.x + box.width * 0.2, box.y + box.height * 0.5, { steps: 10 })
      await page.mouse.up()
    }

    // Wait for navigation and new products to load
    await page.waitForTimeout(1000)
    await page.waitForSelector('[data-testid="product-card"]', { state: 'visible' })

    // Verify we're on page 2
    await expect(page).toHaveURL(/page=2/)

    // Verify products changed
    const firstProductPage2 = await page.locator('[data-testid="product-card"]').first().textContent()
    expect(firstProductPage2).not.toBe(firstProductPage1)

    console.log('✅ Pagination Page 1 → Page 2: PASSED')
  })

  test('should navigate from page 2 to page 3 using swipe left gesture (BUG FIX VALIDATION)', async ({ page }) => {
    // Navigate to page 2 first
    await page.goto('http://localhost:3002/products?page=2')
    await page.waitForSelector('[data-testid="product-card"]', { state: 'visible' })

    // Verify we're on page 2
    await expect(page).toHaveURL(/page=2/)

    // Get first product title on page 2
    const firstProductPage2 = await page.locator('[data-testid="product-card"]').first().textContent()

    // Simulate swipe left gesture (next page)
    const container = await page.locator('main').first()
    const box = await container.boundingBox()

    if (box) {
      await page.mouse.move(box.x + box.width * 0.8, box.y + box.height * 0.5)
      await page.mouse.down()
      await page.mouse.move(box.x + box.width * 0.2, box.y + box.height * 0.5, { steps: 10 })
      await page.mouse.up()
    }

    // Wait for navigation and new products to load
    await page.waitForTimeout(1000)
    await page.waitForSelector('[data-testid="product-card"]', { state: 'visible' })

    // Verify we're on page 3
    await expect(page).toHaveURL(/page=3/)

    // Verify products changed
    const firstProductPage3 = await page.locator('[data-testid="product-card"]').first().textContent()
    expect(firstProductPage3).not.toBe(firstProductPage2)

    console.log('✅ Pagination Page 2 → Page 3: PASSED (BUG FIX VALIDATED)')
  })

  test('should navigate backward from page 3 to page 2 using swipe right gesture', async ({ page }) => {
    // Navigate to page 3
    await page.goto('http://localhost:3002/products?page=3')
    await page.waitForSelector('[data-testid="product-card"]', { state: 'visible' })

    // Verify we're on page 3
    await expect(page).toHaveURL(/page=3/)

    // Get first product title on page 3
    const firstProductPage3 = await page.locator('[data-testid="product-card"]').first().textContent()

    // Simulate swipe right gesture (previous page)
    const container = await page.locator('main').first()
    const box = await container.boundingBox()

    if (box) {
      // Swipe from left to right (20% to 80% of width)
      await page.mouse.move(box.x + box.width * 0.2, box.y + box.height * 0.5)
      await page.mouse.down()
      await page.mouse.move(box.x + box.width * 0.8, box.y + box.height * 0.5, { steps: 10 })
      await page.mouse.up()
    }

    // Wait for navigation and new products to load
    await page.waitForTimeout(1000)
    await page.waitForSelector('[data-testid="product-card"]', { state: 'visible' })

    // Verify we're on page 2
    await expect(page).toHaveURL(/page=2/)

    // Verify products changed
    const firstProductPage2 = await page.locator('[data-testid="product-card"]').first().textContent()
    expect(firstProductPage2).not.toBe(firstProductPage3)

    console.log('✅ Pagination Page 3 → Page 2 (backward): PASSED')
  })

  test('should navigate backward from page 2 to page 1 using swipe right gesture', async ({ page }) => {
    // Navigate to page 2
    await page.goto('http://localhost:3002/products?page=2')
    await page.waitForSelector('[data-testid="product-card"]', { state: 'visible' })

    // Verify we're on page 2
    await expect(page).toHaveURL(/page=2/)

    // Simulate swipe right gesture (previous page)
    const container = await page.locator('main').first()
    const box = await container.boundingBox()

    if (box) {
      await page.mouse.move(box.x + box.width * 0.2, box.y + box.height * 0.5)
      await page.mouse.down()
      await page.mouse.move(box.x + box.width * 0.8, box.y + box.height * 0.5, { steps: 10 })
      await page.mouse.up()
    }

    // Wait for navigation and new products to load
    await page.waitForTimeout(1000)
    await page.waitForSelector('[data-testid="product-card"]', { state: 'visible' })

    // Verify we're on page 1
    await expect(page).toHaveURL(/page=1|^http:\/\/localhost:3002\/products$/)

    console.log('✅ Pagination Page 2 → Page 1 (backward): PASSED')
  })

  test('should handle multiple consecutive swipes correctly', async ({ page }) => {
    // Start on page 1
    await expect(page).toHaveURL(/page=1|^http:\/\/localhost:3002\/products$/)

    const container = await page.locator('main').first()
    const box = await container.boundingBox()

    if (!box) {
      throw new Error('Could not get container bounding box')
    }

    // Swipe left 3 times rapidly (page 1 → 2 → 3 → 4)
    for (let i = 0; i < 3; i++) {
      await page.mouse.move(box.x + box.width * 0.8, box.y + box.height * 0.5)
      await page.mouse.down()
      await page.mouse.move(box.x + box.width * 0.2, box.y + box.height * 0.5, { steps: 10 })
      await page.mouse.up()

      // Wait between swipes
      await page.waitForTimeout(800)
      await page.waitForSelector('[data-testid="product-card"]', { state: 'visible' })
    }

    // Should be on page 4 now
    await expect(page).toHaveURL(/page=4/)

    // Swipe right 2 times (page 4 → 3 → 2)
    for (let i = 0; i < 2; i++) {
      await page.mouse.move(box.x + box.width * 0.2, box.y + box.height * 0.5)
      await page.mouse.down()
      await page.mouse.move(box.x + box.width * 0.8, box.y + box.height * 0.5, { steps: 10 })
      await page.mouse.up()

      // Wait between swipes
      await page.waitForTimeout(800)
      await page.waitForSelector('[data-testid="product-card"]', { state: 'visible' })
    }

    // Should be on page 2 now
    await expect(page).toHaveURL(/page=2/)

    console.log('✅ Multiple consecutive swipes: PASSED')
  })

  test('should not navigate beyond last page', async ({ page }) => {
    // Navigate to a high page number (assuming we don't have that many pages)
    const lastPage = 10 // Adjust based on your actual product count
    await page.goto(`http://localhost:3002/products?page=${lastPage}`)
    await page.waitForTimeout(1000)

    // Get current URL
    const urlBeforeSwipe = page.url()

    // Try to swipe left (should not navigate further)
    const container = await page.locator('main').first()
    const box = await container.boundingBox()

    if (box) {
      await page.mouse.move(box.x + box.width * 0.8, box.y + box.height * 0.5)
      await page.mouse.down()
      await page.mouse.move(box.x + box.width * 0.2, box.y + box.height * 0.5, { steps: 10 })
      await page.mouse.up()
    }

    await page.waitForTimeout(1000)

    // URL should not have changed
    expect(page.url()).toBe(urlBeforeSwipe)

    console.log('✅ Boundary check (last page): PASSED')
  })

  test('should not navigate before first page', async ({ page }) => {
    // Already on page 1
    await expect(page).toHaveURL(/page=1|^http:\/\/localhost:3002\/products$/)

    // Get current URL
    const urlBeforeSwipe = page.url()

    // Try to swipe right (should not navigate to page 0 or negative)
    const container = await page.locator('main').first()
    const box = await container.boundingBox()

    if (box) {
      await page.mouse.move(box.x + box.width * 0.2, box.y + box.height * 0.5)
      await page.mouse.down()
      await page.mouse.move(box.x + box.width * 0.8, box.y + box.height * 0.5, { steps: 10 })
      await page.mouse.up()
    }

    await page.waitForTimeout(1000)

    // URL should still show page 1 or default
    await expect(page).toHaveURL(/page=1|^http:\/\/localhost:3002\/products$/)

    console.log('✅ Boundary check (first page): PASSED')
  })
})

test.describe('Mobile Pagination - Click Navigation After Swipe', () => {
  test.use({
    viewport: { width: 375, height: 667 },
    isMobile: true,
    hasTouch: true
  })

  test('should allow click navigation after using swipe gestures', async ({ page }) => {
    await page.goto('http://localhost:3002/products')
    await page.waitForSelector('[data-testid="product-card"]', { state: 'visible' })

    // Swipe to page 2
    const container = await page.locator('main').first()
    const box = await container.boundingBox()

    if (box) {
      await page.mouse.move(box.x + box.width * 0.8, box.y + box.height * 0.5)
      await page.mouse.down()
      await page.mouse.move(box.x + box.width * 0.2, box.y + box.height * 0.5, { steps: 10 })
      await page.mouse.up()
    }

    await page.waitForTimeout(1000)
    await expect(page).toHaveURL(/page=2/)

    // Now click on page 3 button (if pagination UI exists)
    const page3Button = page.locator('button:has-text("3"), a:has-text("3")').first()

    if (await page3Button.isVisible()) {
      await page3Button.click()
      await page.waitForTimeout(1000)
      await expect(page).toHaveURL(/page=3/)

      console.log('✅ Click navigation after swipe: PASSED')
    } else {
      console.log('⚠️ Pagination buttons not visible, skipping click test')
    }
  })
})
